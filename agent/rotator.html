<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta http-equiv="Cache-Control" content="no-store"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Infokiosk Rotator</title>
<style>
  html,body { margin:0; padding:0; background:#000; height:100%; }
  #wrap { position:fixed; inset:0; }
  iframe { width:100%; height:100%; border:0; background:#111; }
  #overlay {
    position:absolute; inset:0; display:none; align-items:center; justify-content:center;
    background:#000; color:#fff; font:16px system-ui, sans-serif; text-align:center; padding:2rem;
  }
</style>
</head>
<body>
<div id="wrap">
  <iframe id="view" src="about:blank" referrerpolicy="no-referrer"></iframe>
  <div id="overlay"></div>
</div>
<script>
let playlist = [];
let idx = -1;
let timer = null;

async function fetchPlaylist() {
  try {
    const r = await fetch('/api/playlist', { cache:'no-store' });
    if (!r.ok) throw new Error('bad status');
    playlist = await r.json();
  } catch (e) {
    console.error('Playlist fetch failed', e);
  }
}

function showOverlay(msg) {
  const o = document.getElementById('overlay');
  o.textContent = msg;
  o.style.display = 'flex';
}

function hideOverlay() {
  document.getElementById('overlay').style.display = 'none';
}

function next() {
  if (!playlist.length) {
    showOverlay('No items in playlist. Waiting…');
    timer = setTimeout(tick, 5000);
    return;
  }
  hideOverlay();
  idx = (idx + 1) % playlist.length;
  const { url, timeout } = playlist[idx];
  const frame = document.getElementById('view');

  let loaded = false;
  const onload = () => { loaded = true; };
  frame.onload = onload;

  // If the site forbids embedding, we wait 3s then skip with a note
  setTimeout(() => {
    if (!loaded) {
      showOverlay('This site forbids embedding:\n' + url + '\nSkipping…');
    }
  }, 3000);

  frame.src = url;

  const t = Math.max(5, Number(timeout) || 30) * 1000;
  timer = setTimeout(tick, t);
}

async function tick() {
  clearTimeout(timer);
  // refresh playlist every cycle
  await fetchPlaylist();
  next();
}

(async () => {
  await fetchPlaylist();
  next();
})();
</script>
</body>
</html>

